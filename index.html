<!DOCTYPE html>
<html>
 
<head>
 
<title>heatmapDemo</title>
 
<meta http-equiv="Content-Type" content="application/x-javascript; charset=utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
<meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>

<script>
	   	var dojoConfig = {
	       	serverIP: "192.168.120.72:8888"
		};
</script>
		<link rel="stylesheet" type="text/css" href="http://192.168.120.72:8888/arcgis_js_api/v38/library/3.8/js/dojo/dijit/themes/claro/claro.css"> 
		<link rel="stylesheet" type="text/css" href="http://192.168.120.72:8888/arcgis_js_api/v38/library/3.8/js/esri/css/esri.css" />
		<script src="http://192.168.120.72:8888/arcgis_js_api/v38/library/3.8/init.js"></script>

<script type="text/javascript" src="static/jquery-1.11.0.js"></script>
<script type="text/javascript" src="static/heatmap.js"></script>
<script type="text/javascript" src="static/heatmap-arcgis.js"></script>
<style>
  html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
  #map{
        padding:0;
  }
    #flowContainer{
    font: inherit;
    line-height: normal;
    color: inherit;
  }
</style>
<script type="text/javascript"> 





  def  = [[2, 99, 0,120],[88, 176, 0,120],[150, 209, 0,120],[255, 213, 0,120],[255, 38, 0,120]];
  blue = [[198,219,239,180],[158,202,225,180],[107,174,214,180],[49,130,189,180],[8,81,156,180]];
  red = [[252,187,161,180],[252,146,114,180],[251,106,74,180],[222,45,38,180],[165,15,21,180]];
  green = [[199,233,192,180],[161,217,155,180],[116,196,118,180],[49,163,84,180],[0,109,44,180]];
  orange = [[254,196,79,120],[254,153,41,120],[236,112,20,120],[204,76,2,120],[140,45,4,120]];

  var coloful = [def,blue,red,green,orange];


 require(["esri/map", "esri/graphic", "dojo/request/script", "dojo/number", "dojo/dom",
	         "esri/layers/ArcGISTiledMapServiceLayer", "esri/geometry/webMercatorUtils", "esri/geometry/Point",
	         "esri/SpatialReference", "esri/arcgis/utils", "dojo/on", "dojo/parser", "dojo/_base/array","dojo/domReady!"],
			
			function(Map, Graphic, script, number, dom, ArcGISTiledMapServiceLayer,
					webMercatorUtils, Point, SpatialReference, arcgisUtils, on, parser, array) {
    	dojo.parser.parse();
    	var agoServiceURL = "http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineCommunity/MapServer";
     	
    	var lods = [ 
       {
          "level": 9,
          "resolution": 305.74811314055756,
          "scale":1155581.108577
        }, {
          "level": 10,
          "resolution": 152.87405657041106,
          "scale": 577790.55428899999
        },
       {
          "level": 11,
          "resolution": 76.437028285073239,
          "scale": 288895.27714399999
        },
      {
          "level": 12,
          "resolution": 38.21851414253662,
          "scale": 144447.638572
        }, {
          "level": 13,
          "resolution": 19.10925707126831,
          "scale": 72223.819285999998
        }, {
          "level": 14,
          "resolution": 9.5546285356341549,
          "scale": 36111.909642999999
        }];	
      	var map = new Map("map", {
        	center: [116.33, 39.9],
        	lods: lods,
        	zoom: 4,
        	sliderStyle: "large"
      	});
    
    var maplist = [map];
    var dataSize = maplist.length;
    var agoLayerList = [];
    
    for( var i=0;i<dataSize;i++)
    {
    	var agoLayer = new esri.layers.ArcGISTiledMapServiceLayer(agoServiceURL, { displayLevels:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]});
    	agoLayerList.push(agoLayer);
    }
    
    var featureLayer = new esri.layers.ArcGISTiledMapServiceLayer(agoServiceURL, { displayLevels:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]});
	var heatLayer;
	
	function getHeatData(obj,searchtb)
	{
		//var Odata = {"val": [[12939296.93323845, 4861882.1373, 500, {"busstations": 16}], [12940162.958642237, 4862382.1373, 500, {"busstations": 6}], [12941028.98404602, 4861882.1373, 500, {"busstations": 20}], [12941895.009449806, 4862382.1373, 500, {"busstations": 18}], [12942761.034853589, 4861882.1373, 500, {"busstations": 15}], [12943627.060257375, 4862382.1373, 500, {"busstations": 4}], [12944493.085661158, 4861882.1373, 500, {"busstations": 20}], [12945359.11106494, 4862382.1373, 500, {"busstations": 12}], [12946225.136468727, 4861882.1373, 500, {"busstations": 50}], [12947091.16187251, 4862382.1373, 500, {"busstations": 61}], [12948823.212680079, 4862382.1373, 500, {"busstations": 66}], [12949689.238083865, 4861882.1373, 500, {"busstations": 11}], [12950555.263487648, 4862382.1373, 500, {"busstations": 10}], [12952287.314295217, 4862382.1373, 500, {"busstations": 32}], [12954019.365102787, 4862382.1373, 500, {"busstations": 29}], [12955751.415910356, 4862382.1373, 500, {"busstations": 21}], [12956617.441314138, 4861882.1373, 500, {"busstations": 38}], [12957483.466717925, 4862382.1373, 500, {"busstations": 29}], [12958349.492121708, 4861882.1373, 500, {"busstations": 52}], [12959215.517525494, 4862382.1373, 500, {"busstations": 66}], [12960081.542929277, 4861882.1373, 500, {"busstations": 76}], [12940162.958642237, 4861382.1373, 500, {"busstations": 2}], [12941028.98404602, 4860882.1373, 500, {"busstations": 5}], [12941895.009449806, 4861382.1373, 500, {"busstations": 2}], [12943627.060257375, 4861382.1373, 500, {"busstations": 31}], [12944493.085661158, 4860882.1373, 500, {"busstations": 11}], [12945359.11106494, 4861382.1373, 500, {"busstations": 9}], [12946225.136468727, 4860882.1373, 500, {"busstations": 25}], [12947091.16187251, 4861382.1373, 500, {"busstations": 32}], [12947957.187276296, 4860882.1373, 500, {"busstations": 40}], [12948823.212680079, 4861382.1373, 500, {"busstations": 56}], [12949689.238083865, 4860882.1373, 500, {"busstations": 21}], [12950555.263487648, 4861382.1373, 500, {"busstations": 45}], [12951421.288891435, 4860882.1373, 500, {"busstations": 23}], [12952287.314295217, 4861382.1373, 500, {"busstations": 80}], [12953153.339699004, 4860882.1373, 500, {"busstations": 27}], [12954019.365102787, 4861382.1373, 500, {"busstations": 97}], [12954885.390506573, 4860882.1373, 500, {"busstations": 60}], [12955751.415910356, 4861382.1373, 500, {"busstations": 62}], [12956617.441314138, 4860882.1373, 500, {"busstations": 55}], [12957483.466717925, 4861382.1373, 500, {"busstations": 38}], [12958349.492121708, 4860882.1373, 500, {"busstations": 24}], [12959215.517525494, 4861382.1373, 500, {"busstations": 14}], [12960081.542929277, 4860882.1373, 500, {"busstations": 31}], [12939296.93323845, 4859882.1373, 500, {"busstations": 12}], [12940162.958642237, 4860382.1373, 500, {"busstations": 2}], [12941028.98404602, 4859882.1373, 500, {"busstations": 1}], [12942761.034853589, 4859882.1373, 500, {"busstations": 1}], [12943627.060257375, 4860382.1373, 500, {"busstations": 94}], [12944493.085661158, 4859882.1373, 500, {"busstations": 18}], [12945359.11106494, 4860382.1373, 500, {"busstations": 37}], [12946225.136468727, 4859882.1373, 500, {"busstations": 22}], [12947091.16187251, 4860382.1373, 500, {"busstations": 33}], [12947957.187276296, 4859882.1373, 500, {"busstations": 11}], [12948823.212680079, 4860382.1373, 500, {"busstations": 35}], [12949689.238083865, 4859882.1373, 500, {"busstations": 9}], [12950555.263487648, 4860382.1373, 500, {"busstations": 13}], [12951421.288891435, 4859882.1373, 500, {"busstations": 30}], [12952287.314295217, 4860382.1373, 500, {"busstations": 45}], [12953153.339699004, 4859882.1373, 500, {"busstations": 13}], [12954019.365102787, 4860382.1373, 500, {"busstations": 34}], [12954885.390506573, 4859882.1373, 500, {"busstations": 14}], [12956617.441314138, 4859882.1373, 500, {"busstations": 2}], [12957483.466717925, 4860382.1373, 500, {"busstations": 5}], [12958349.492121708, 4859882.1373, 500, {"busstations": 37}], [12959215.517525494, 4860382.1373, 500, {"busstations": 7}], [12960081.542929277, 4859882.1373, 500, {"busstations": 23}], [12940162.958642237, 4859382.1373, 500, {"busstations": 4}], [12942761.034853589, 4858882.1373, 500, {"busstations": 1}], [12943627.060257375, 4859382.1373, 500, {"busstations": 32}], [12944493.085661158, 4858882.1373, 500, {"busstations": 7}], [12945359.11106494, 4859382.1373, 500, {"busstations": 3}], [12946225.136468727, 4858882.1373, 500, {"busstations": 9}], [12947091.16187251, 4859382.1373, 500, {"busstations": 57}], [12947957.187276296, 4858882.1373, 500, {"busstations": 1}], [12948823.212680079, 4859382.1373, 500, {"busstations": 65}], [12949689.238083865, 4858882.1373, 500, {"busstations": 8}], [12950555.263487648, 4859382.1373, 500, {"busstations": 25}], [12951421.288891435, 4858882.1373, 500, {"busstations": 11}], [12952287.314295217, 4859382.1373, 500, {"busstations": 17}], [12953153.339699004, 4858882.1373, 500, {"busstations": 14}], [12954019.365102787, 4859382.1373, 500, {"busstations": 25}], [12954885.390506573, 4858882.1373, 500, {"busstations": 71}], [12955751.415910356, 4859382.1373, 500, {"busstations": 24}], [12956617.441314138, 4858882.1373, 500, {"busstations": 27}], [12957483.466717925, 4859382.1373, 500, {"busstations": 12}], [12958349.492121708, 4858882.1373, 500, {"busstations": 58}], [12959215.517525494, 4859382.1373, 500, {"busstations": 24}], [12960081.542929277, 4858882.1373, 500, {"busstations": 36}], [12940162.958642237, 4858382.1373, 500, {"busstations": 12}], [12941028.98404602, 4857882.1373, 500, {"busstations": 16}], [12941895.009449806, 4858382.1373, 500, {"busstations": 16}], [12942761.034853589, 4857882.1373, 500, {"busstations": 16}], [12943627.060257375, 4858382.1373, 500, {"busstations": 70}], [12944493.085661158, 4857882.1373, 500, {"busstations": 18}], [12945359.11106494, 4858382.1373, 500, {"busstations": 53}], [12946225.136468727, 4857882.1373, 500, {"busstations": 47}], [12947091.16187251, 4858382.1373, 500, {"busstations": 63}], [12947957.187276296, 4857882.1373, 500, {"busstations": 22}], [12948823.212680079, 4858382.1373, 500, {"busstations": 4}], [12949689.238083865, 4857882.1373, 500, {"busstations": 34}], [12950555.263487648, 4858382.1373, 500, {"busstations": 1}], [12951421.288891435, 4857882.1373, 500, {"busstations": 17}], [12952287.314295217, 4858382.1373, 500, {"busstations": 34}], [12953153.339699004, 4857882.1373, 500, {"busstations": 17}], [12954019.365102787, 4858382.1373, 500, {"busstations": 11}], [12954885.390506573, 4857882.1373, 500, {"busstations": 22}], [12955751.415910356, 4858382.1373, 500, {"busstations": 9}], [12956617.441314138, 4857882.1373, 500, {"busstations": 17}], [12958349.492121708, 4857882.1373, 500, {"busstations": 30}], [12959215.517525494, 4858382.1373, 500, {"busstations": 16}], [12960081.542929277, 4857882.1373, 500, {"busstations": 5}], [12941028.98404602, 4856882.1373, 500, {"busstations": 2}], [12943627.060257375, 4857382.1373, 500, {"busstations": 47}], [12946225.136468727, 4856882.1373, 500, {"busstations": 20}], [12947091.16187251, 4857382.1373, 500, {"busstations": 11}], [12947957.187276296, 4856882.1373, 500, {"busstations": 39}], [12948823.212680079, 4857382.1373, 500, {"busstations": 25}], [12949689.238083865, 4856882.1373, 500, {"busstations": 67}], [12950555.263487648, 4857382.1373, 500, {"busstations": 68}], [12951421.288891435, 4856882.1373, 500, {"busstations": 38}], [12952287.314295217, 4857382.1373, 500, {"busstations": 84}], [12953153.339699004, 4856882.1373, 500, {"busstations": 13}], [12954019.365102787, 4857382.1373, 500, {"busstations": 18}], [12954885.390506573, 4856882.1373, 500, {"busstations": 18}], [12955751.415910356, 4857382.1373, 500, {"busstations": 2}], [12957483.466717925, 4857382.1373, 500, {"busstations": 36}], [12958349.492121708, 4856882.1373, 500, {"busstations": 34}], [12959215.517525494, 4857382.1373, 500, {"busstations": 30}], [12960081.542929277, 4856882.1373, 500, {"busstations": 14}], [12939296.93323845, 4855882.1373, 500, {"busstations": 16}], [12940162.958642237, 4856382.1373, 500, {"busstations": 26}], [12941028.98404602, 4855882.1373, 500, {"busstations": 28}], [12941895.009449806, 4856382.1373, 500, {"busstations": 10}], [12942761.034853589, 4855882.1373, 500, {"busstations": 25}], [12943627.060257375, 4856382.1373, 500, {"busstations": 70}], [12944493.085661158, 4855882.1373, 500, {"busstations": 23}], [12945359.11106494, 4856382.1373, 500, {"busstations": 12}], [12946225.136468727, 4855882.1373, 500, {"busstations": 22}], [12947091.16187251, 4856382.1373, 500, {"busstations": 20}], [12947957.187276296, 4855882.1373, 500, {"busstations": 67}], [12948823.212680079, 4856382.1373, 500, {"busstations": 17}], [12949689.238083865, 4855882.1373, 500, {"busstations": 39}], [12950555.263487648, 4856382.1373, 500, {"busstations": 26}], [12951421.288891435, 4855882.1373, 500, {"busstations": 38}], [12952287.314295217, 4856382.1373, 500, {"busstations": 31}], [12953153.339699004, 4855882.1373, 500, {"busstations": 22}], [12954019.365102787, 4856382.1373, 500, {"busstations": 14}], [12954885.390506573, 4855882.1373, 500, {"busstations": 49}], [12955751.415910356, 4856382.1373, 500, {"busstations": 34}], [12956617.441314138, 4855882.1373, 500, {"busstations": 22}], [12957483.466717925, 4856382.1373, 500, {"busstations": 36}], [12958349.492121708, 4855882.1373, 500, {"busstations": 31}], [12959215.517525494, 4856382.1373, 500, {"busstations": 50}], [12960081.542929277, 4855882.1373, 500, {"busstations": 18}], [12939296.93323845, 4854882.1373, 500, {"busstations": 10}], [12940162.958642237, 4855382.1373, 500, {"busstations": 12}], [12941028.98404602, 4854882.1373, 500, {"busstations": 14}], [12941895.009449806, 4855382.1373, 500, {"busstations": 4}], [12942761.034853589, 4854882.1373, 500, {"busstations": 20}], [12943627.060257375, 4855382.1373, 500, {"busstations": 72}], [12944493.085661158, 4854882.1373, 500, {"busstations": 61}], [12945359.11106494, 4855382.1373, 500, {"busstations": 5}], [12946225.136468727, 4854882.1373, 500, {"busstations": 56}], [12947091.16187251, 4855382.1373, 500, {"busstations": 52}], [12947957.187276296, 4854882.1373, 500, {"busstations": 93}], [12948823.212680079, 4855382.1373, 500, {"busstations": 17}], [12949689.238083865, 4854882.1373, 500, {"busstations": 18}], [12950555.263487648, 4855382.1373, 500, {"busstations": 33}], [12951421.288891435, 4854882.1373, 500, {"busstations": 49}], [12952287.314295217, 4855382.1373, 500, {"busstations": 75}], [12953153.339699004, 4854882.1373, 500, {"busstations": 34}], [12954019.365102787, 4855382.1373, 500, {"busstations": 28}], [12954885.390506573, 4854882.1373, 500, {"busstations": 69}], [12955751.415910356, 4855382.1373, 500, {"busstations": 6}], [12956617.441314138, 4854882.1373, 500, {"busstations": 23}], [12957483.466717925, 4855382.1373, 500, {"busstations": 16}], [12958349.492121708, 4854882.1373, 500, {"busstations": 33}], [12959215.517525494, 4855382.1373, 500, {"busstations": 26}], [12960081.542929277, 4854882.1373, 500, {"busstations": 18}], [12939296.93323845, 4853882.1373, 500, {"busstations": 5}], [12940162.958642237, 4854382.1373, 500, {"busstations": 2}], [12941028.98404602, 4853882.1373, 500, {"busstations": 35}], [12941895.009449806, 4854382.1373, 500, {"busstations": 17}], [12942761.034853589, 4853882.1373, 500, {"busstations": 30}], [12943627.060257375, 4854382.1373, 500, {"busstations": 31}], [12944493.085661158, 4853882.1373, 500, {"busstations": 6}], [12946225.136468727, 4853882.1373, 500, {"busstations": 15}], [12947091.16187251, 4854382.1373, 500, {"busstations": 17}], [12947957.187276296, 4853882.1373, 500, {"busstations": 8}], [12950555.263487648, 4854382.1373, 500, {"busstations": 15}], [12951421.288891435, 4853882.1373, 500, {"busstations": 43}], [12952287.314295217, 4854382.1373, 500, {"busstations": 32}], [12953153.339699004, 4853882.1373, 500, {"busstations": 15}], [12954019.365102787, 4854382.1373, 500, {"busstations": 9}], [12954885.390506573, 4853882.1373, 500, {"busstations": 24}], [12955751.415910356, 4854382.1373, 500, {"busstations": 2}], [12956617.441314138, 4853882.1373, 500, {"busstations": 2}], [12958349.492121708, 4853882.1373, 500, {"busstations": 16}], [12959215.517525494, 4854382.1373, 500, {"busstations": 54}], [12960081.542929277, 4853882.1373, 500, {"busstations": 5}], [12939296.93323845, 4852882.1373, 500, {"busstations": 37}], [12940162.958642237, 4853382.1373, 500, {"busstations": 17}], [12941028.98404602, 4852882.1373, 500, {"busstations": 49}], [12941895.009449806, 4853382.1373, 500, {"busstations": 14}], [12942761.034853589, 4852882.1373, 500, {"busstations": 21}], [12943627.060257375, 4853382.1373, 500, {"busstations": 31}], [12944493.085661158, 4852882.1373, 500, {"busstations": 24}], [12945359.11106494, 4853382.1373, 500, {"busstations": 36}], [12946225.136468727, 4852882.1373, 500, {"busstations": 33}], [12947091.16187251, 4853382.1373, 500, {"busstations": 55}], [12947957.187276296, 4852882.1373, 500, {"busstations": 74}], [12948823.212680079, 4853382.1373, 500, {"busstations": 29}], [12949689.238083865, 4852882.1373, 500, {"busstations": 5}], [12950555.263487648, 4853382.1373, 500, {"busstations": 49}], [12951421.288891435, 4852882.1373, 500, {"busstations": 18}], [12952287.314295217, 4853382.1373, 500, {"busstations": 61}], [12953153.339699004, 4852882.1373, 500, {"busstations": 47}], [12954019.365102787, 4853382.1373, 500, {"busstations": 17}], [12954885.390506573, 4852882.1373, 500, {"busstations": 35}], [12955751.415910356, 4853382.1373, 500, {"busstations": 5}], [12956617.441314138, 4852882.1373, 500, {"busstations": 20}], [12957483.466717925, 4853382.1373, 500, {"busstations": 26}], [12958349.492121708, 4852882.1373, 500, {"busstations": 16}], [12959215.517525494, 4853382.1373, 500, {"busstations": 37}], [12960081.542929277, 4852882.1373, 500, {"busstations": 25}], [12939296.93323845, 4851882.1373, 500, {"busstations": 26}], [12940162.958642237, 4852382.1373, 500, {"busstations": 61}], [12941028.98404602, 4851882.1373, 500, {"busstations": 54}], [12941895.009449806, 4852382.1373, 500, {"busstations": 21}], [12942761.034853589, 4851882.1373, 500, {"busstations": 40}], [12943627.060257375, 4852382.1373, 500, {"busstations": 53}], [12944493.085661158, 4851882.1373, 500, {"busstations": 16}], [12945359.11106494, 4852382.1373, 500, {"busstations": 16}], [12946225.136468727, 4851882.1373, 500, {"busstations": 1}], [12947091.16187251, 4852382.1373, 500, {"busstations": 9}], [12947957.187276296, 4851882.1373, 500, {"busstations": 74}], [12948823.212680079, 4852382.1373, 500, {"busstations": 25}], [12949689.238083865, 4851882.1373, 500, {"busstations": 6}], [12950555.263487648, 4852382.1373, 500, {"busstations": 10}], [12951421.288891435, 4851882.1373, 500, {"busstations": 36}], [12952287.314295217, 4852382.1373, 500, {"busstations": 32}], [12953153.339699004, 4851882.1373, 500, {"busstations": 37}], [12954019.365102787, 4852382.1373, 500, {"busstations": 13}], [12954885.390506573, 4851882.1373, 500, {"busstations": 45}], [12955751.415910356, 4852382.1373, 500, {"busstations": 30}], [12956617.441314138, 4851882.1373, 500, {"busstations": 27}], [12957483.466717925, 4852382.1373, 500, {"busstations": 30}], [12958349.492121708, 4851882.1373, 500, {"busstations": 28}], [12959215.517525494, 4852382.1373, 500, {"busstations": 41}], [12960081.542929277, 4851882.1373, 500, {"busstations": 52}], [12939296.93323845, 4850882.1373, 500, {"busstations": 32}], [12940162.958642237, 4851382.1373, 500, {"busstations": 8}], [12941028.98404602, 4850882.1373, 500, {"busstations": 28}], [12941895.009449806, 4851382.1373, 500, {"busstations": 4}], [12942761.034853589, 4850882.1373, 500, {"busstations": 33}], [12943627.060257375, 4851382.1373, 500, {"busstations": 50}], [12944493.085661158, 4850882.1373, 500, {"busstations": 2}], [12945359.11106494, 4851382.1373, 500, {"busstations": 2}], [12946225.136468727, 4850882.1373, 500, {"busstations": 32}], [12947091.16187251, 4851382.1373, 500, {"busstations": 3}], [12947957.187276296, 4850882.1373, 500, {"busstations": 11}], [12948823.212680079, 4851382.1373, 500, {"busstations": 97}], [12949689.238083865, 4850882.1373, 500, {"busstations": 9}], [12950555.263487648, 4851382.1373, 500, {"busstations": 42}], [12951421.288891435, 4850882.1373, 500, {"busstations": 34}], [12952287.314295217, 4851382.1373, 500, {"busstations": 56}], [12953153.339699004, 4850882.1373, 500, {"busstations": 29}], [12954019.365102787, 4851382.1373, 500, {"busstations": 23}], [12954885.390506573, 4850882.1373, 500, {"busstations": 21}], [12955751.415910356, 4851382.1373, 500, {"busstations": 12}], [12956617.441314138, 4850882.1373, 500, {"busstations": 19}], [12957483.466717925, 4851382.1373, 500, {"busstations": 45}], [12959215.517525494, 4851382.1373, 500, {"busstations": 29}], [12960081.542929277, 4850882.1373, 500, {"busstations": 39}], [12939296.93323845, 4849882.1373, 500, {"busstations": 23}], [12940162.958642237, 4850382.1373, 500, {"busstations": 16}], [12941028.98404602, 4849882.1373, 500, {"busstations": 48}], [12941895.009449806, 4850382.1373, 500, {"busstations": 4}], [12942761.034853589, 4849882.1373, 500, {"busstations": 14}], [12943627.060257375, 4850382.1373, 500, {"busstations": 36}], [12944493.085661158, 4849882.1373, 500, {"busstations": 5}], [12945359.11106494, 4850382.1373, 500, {"busstations": 9}], [12946225.136468727, 4849882.1373, 500, {"busstations": 40}], [12947091.16187251, 4850382.1373, 500, {"busstations": 6}], [12947957.187276296, 4849882.1373, 500, {"busstations": 152}], [12948823.212680079, 4850382.1373, 500, {"busstations": 69}], [12949689.238083865, 4849882.1373, 500, {"busstations": 54}], [12950555.263487648, 4850382.1373, 500, {"busstations": 48}], [12951421.288891435, 4849882.1373, 500, {"busstations": 20}], [12952287.314295217, 4850382.1373, 500, {"busstations": 59}], [12953153.339699004, 4849882.1373, 500, {"busstations": 91}], [12954019.365102787, 4850382.1373, 500, {"busstations": 12}], [12954885.390506573, 4849882.1373, 500, {"busstations": 33}], [12955751.415910356, 4850382.1373, 500, {"busstations": 33}], [12956617.441314138, 4849882.1373, 500, {"busstations": 26}], [12957483.466717925, 4850382.1373, 500, {"busstations": 57}], [12958349.492121708, 4849882.1373, 500, {"busstations": 32}], [12959215.517525494, 4850382.1373, 500, {"busstations": 29}], [12960081.542929277, 4849882.1373, 500, {"busstations": 18}], [12939296.93323845, 4848882.1373, 500, {"busstations": 10}], [12941028.98404602, 4848882.1373, 500, {"busstations": 6}], [12942761.034853589, 4848882.1373, 500, {"busstations": 15}], [12943627.060257375, 4849382.1373, 500, {"busstations": 36}], [12944493.085661158, 4848882.1373, 500, {"busstations": 2}], [12946225.136468727, 4848882.1373, 500, {"busstations": 22}], [12947091.16187251, 4849382.1373, 500, {"busstations": 20}], [12947957.187276296, 4848882.1373, 500, {"busstations": 64}], [12948823.212680079, 4849382.1373, 500, {"busstations": 19}], [12949689.238083865, 4848882.1373, 500, {"busstations": 13}], [12950555.263487648, 4849382.1373, 500, {"busstations": 7}], [12951421.288891435, 4848882.1373, 500, {"busstations": 19}], [12952287.314295217, 4849382.1373, 500, {"busstations": 41}], [12953153.339699004, 4848882.1373, 500, {"busstations": 26}], [12954019.365102787, 4849382.1373, 500, {"busstations": 11}], [12954885.390506573, 4848882.1373, 500, {"busstations": 20}], [12955751.415910356, 4849382.1373, 500, {"busstations": 14}], [12956617.441314138, 4848882.1373, 500, {"busstations": 38}], [12957483.466717925, 4849382.1373, 500, {"busstations": 60}], [12960081.542929277, 4848882.1373, 500, {"busstations": 82}], [12939296.93323845, 4847882.1373, 500, {"busstations": 12}], [12940162.958642237, 4848382.1373, 500, {"busstations": 2}], [12941028.98404602, 4847882.1373, 500, {"busstations": 7}], [12941895.009449806, 4848382.1373, 500, {"busstations": 10}], [12942761.034853589, 4847882.1373, 500, {"busstations": 4}], [12943627.060257375, 4848382.1373, 500, {"busstations": 36}], [12944493.085661158, 4847882.1373, 500, {"busstations": 37}], [12945359.11106494, 4848382.1373, 500, {"busstations": 4}], [12946225.136468727, 4847882.1373, 500, {"busstations": 11}], [12947957.187276296, 4847882.1373, 500, {"busstations": 46}], [12948823.212680079, 4848382.1373, 500, {"busstations": 17}], [12949689.238083865, 4847882.1373, 500, {"busstations": 18}], [12950555.263487648, 4848382.1373, 500, {"busstations": 10}], [12951421.288891435, 4847882.1373, 500, {"busstations": 11}], [12952287.314295217, 4848382.1373, 500, {"busstations": 29}], [12953153.339699004, 4847882.1373, 500, {"busstations": 22}], [12954019.365102787, 4848382.1373, 500, {"busstations": 21}], [12954885.390506573, 4847882.1373, 500, {"busstations": 12}], [12955751.415910356, 4848382.1373, 500, {"busstations": 10}], [12956617.441314138, 4847882.1373, 500, {"busstations": 28}], [12957483.466717925, 4848382.1373, 500, {"busstations": 72}], [12958349.492121708, 4847882.1373, 500, {"busstations": 13}], [12959215.517525494, 4848382.1373, 500, {"busstations": 14}], [12960081.542929277, 4847882.1373, 500, {"busstations": 22}], [12939296.93323845, 4846882.1373, 500, {"busstations": 4}], [12940162.958642237, 4847382.1373, 500, {"busstations": 4}], [12941028.98404602, 4846882.1373, 500, {"busstations": 10}], [12941895.009449806, 4847382.1373, 500, {"busstations": 6}], [12942761.034853589, 4846882.1373, 500, {"busstations": 2}], [12943627.060257375, 4847382.1373, 500, {"busstations": 11}], [12944493.085661158, 4846882.1373, 500, {"busstations": 45}], [12945359.11106494, 4847382.1373, 500, {"busstations": 60}], [12946225.136468727, 4846882.1373, 500, {"busstations": 40}], [12947091.16187251, 4847382.1373, 500, {"busstations": 30}], [12947957.187276296, 4846882.1373, 500, {"busstations": 55}], [12948823.212680079, 4847382.1373, 500, {"busstations": 23}], [12949689.238083865, 4846882.1373, 500, {"busstations": 26}], [12950555.263487648, 4847382.1373, 500, {"busstations": 26}], [12951421.288891435, 4846882.1373, 500, {"busstations": 12}], [12952287.314295217, 4847382.1373, 500, {"busstations": 51}], [12953153.339699004, 4846882.1373, 500, {"busstations": 53}], [12954019.365102787, 4847382.1373, 500, {"busstations": 18}], [12954885.390506573, 4846882.1373, 500, {"busstations": 40}], [12955751.415910356, 4847382.1373, 500, {"busstations": 65}], [12956617.441314138, 4846882.1373, 500, {"busstations": 8}], [12957483.466717925, 4847382.1373, 500, {"busstations": 12}], [12958349.492121708, 4846882.1373, 500, {"busstations": 1}], [12959215.517525494, 4847382.1373, 500, {"busstations": 17}], [12960081.542929277, 4846882.1373, 500, {"busstations": 27}], [12939296.93323845, 4845882.1373, 500, {"busstations": 18}], [12940162.958642237, 4846382.1373, 500, {"busstations": 3}], [12941028.98404602, 4845882.1373, 500, {"busstations": 3}], [12941895.009449806, 4846382.1373, 500, {"busstations": 28}], [12942761.034853589, 4845882.1373, 500, {"busstations": 22}], [12943627.060257375, 4846382.1373, 500, {"busstations": 1}], [12944493.085661158, 4845882.1373, 500, {"busstations": 39}], [12945359.11106494, 4846382.1373, 500, {"busstations": 12}], [12946225.136468727, 4845882.1373, 500, {"busstations": 9}], [12947957.187276296, 4845882.1373, 500, {"busstations": 19}], [12948823.212680079, 4846382.1373, 500, {"busstations": 12}], [12949689.238083865, 4845882.1373, 500, {"busstations": 2}], [12950555.263487648, 4846382.1373, 500, {"busstations": 4}], [12952287.314295217, 4846382.1373, 500, {"busstations": 1}], [12954019.365102787, 4846382.1373, 500, {"busstations": 24}], [12954885.390506573, 4845882.1373, 500, {"busstations": 4}], [12955751.415910356, 4846382.1373, 500, {"busstations": 18}], [12956617.441314138, 4845882.1373, 500, {"busstations": 22}], [12957483.466717925, 4846382.1373, 500, {"busstations": 91}], [12958349.492121708, 4845882.1373, 500, {"busstations": 1}], [12959215.517525494, 4846382.1373, 500, {"busstations": 14}], [12960081.542929277, 4845882.1373, 500, {"busstations": 23}], [12939296.93323845, 4844882.1373, 500, {"busstations": 46}], [12940162.958642237, 4845382.1373, 500, {"busstations": 14}], [12941028.98404602, 4844882.1373, 500, {"busstations": 4}], [12942761.034853589, 4844882.1373, 500, {"busstations": 6}], [12944493.085661158, 4844882.1373, 500, {"busstations": 50}], [12945359.11106494, 4845382.1373, 500, {"busstations": 11}], [12946225.136468727, 4844882.1373, 500, {"busstations": 12}], [12947091.16187251, 4845382.1373, 500, {"busstations": 28}], [12947957.187276296, 4844882.1373, 500, {"busstations": 16}], [12948823.212680079, 4845382.1373, 500, {"busstations": 13}], [12950555.263487648, 4845382.1373, 500, {"busstations": 2}], [12951421.288891435, 4844882.1373, 500, {"busstations": 22}], [12952287.314295217, 4845382.1373, 500, {"busstations": 10}], [12953153.339699004, 4844882.1373, 500, {"busstations": 64}], [12954019.365102787, 4845382.1373, 500, {"busstations": 7}], [12954885.390506573, 4844882.1373, 500, {"busstations": 14}], [12955751.415910356, 4845382.1373, 500, {"busstations": 106}], [12956617.441314138, 4844882.1373, 500, {"busstations": 68}], [12957483.466717925, 4845382.1373, 500, {"busstations": 33}], [12958349.492121708, 4844882.1373, 500, {"busstations": 77}], [12959215.517525494, 4845382.1373, 500, {"busstations": 61}], [12960081.542929277, 4844882.1373, 500, {"busstations": 27}], [12939296.93323845, 4843882.1373, 500, {"busstations": 24}], [12941028.98404602, 4843882.1373, 500, {"busstations": 7}], [12941895.009449806, 4844382.1373, 500, {"busstations": 21}], [12942761.034853589, 4843882.1373, 500, {"busstations": 6}], [12943627.060257375, 4844382.1373, 500, {"busstations": 21}], [12944493.085661158, 4843882.1373, 500, {"busstations": 65}], [12945359.11106494, 4844382.1373, 500, {"busstations": 20}], [12947091.16187251, 4844382.1373, 500, {"busstations": 7}], [12947957.187276296, 4843882.1373, 500, {"busstations": 19}], [12948823.212680079, 4844382.1373, 500, {"busstations": 2}], [12949689.238083865, 4843882.1373, 500, {"busstations": 67}], [12950555.263487648, 4844382.1373, 500, {"busstations": 50}], [12951421.288891435, 4843882.1373, 500, {"busstations": 34}], [12952287.314295217, 4844382.1373, 500, {"busstations": 6}], [12953153.339699004, 4843882.1373, 500, {"busstations": 30}], [12954019.365102787, 4844382.1373, 500, {"busstations": 68}], [12954885.390506573, 4843882.1373, 500, {"busstations": 39}], [12955751.415910356, 4844382.1373, 500, {"busstations": 53}], [12956617.441314138, 4843882.1373, 500, {"busstations": 2}], [12957483.466717925, 4844382.1373, 500, {"busstations": 31}], [12958349.492121708, 4843882.1373, 500, {"busstations": 4}], [12959215.517525494, 4844382.1373, 500, {"busstations": 14}], [12960081.542929277, 4843882.1373, 500, {"busstations": 16}], [12939296.93323845, 4842882.1373, 500, {"busstations": 28}], [12940162.958642237, 4843382.1373, 500, {"busstations": 7}], [12941028.98404602, 4842882.1373, 500, {"busstations": 4}], [12941895.009449806, 4843382.1373, 500, {"busstations": 6}], [12944493.085661158, 4842882.1373, 500, {"busstations": 35}], [12945359.11106494, 4843382.1373, 500, {"busstations": 34}], [12946225.136468727, 4842882.1373, 500, {"busstations": 28}], [12947091.16187251, 4843382.1373, 500, {"busstations": 18}], [12947957.187276296, 4842882.1373, 500, {"busstations": 7}], [12948823.212680079, 4843382.1373, 500, {"busstations": 4}], [12953153.339699004, 4842882.1373, 500, {"busstations": 2}], [12954019.365102787, 4843382.1373, 500, {"busstations": 24}], [12954885.390506573, 4842882.1373, 500, {"busstations": 18}], [12955751.415910356, 4843382.1373, 500, {"busstations": 8}], [12956617.441314138, 4842882.1373, 500, {"busstations": 18}], [12957483.466717925, 4843382.1373, 500, {"busstations": 32}], [12958349.492121708, 4842882.1373, 500, {"busstations": 14}], [12959215.517525494, 4843382.1373, 500, {"busstations": 17}], [12960081.542929277, 4842882.1373, 500, {"busstations": 17}], [12939296.93323845, 4841882.1373, 500, {"busstations": 14}], [12940162.958642237, 4842382.1373, 500, {"busstations": 12}], [12941028.98404602, 4841882.1373, 500, {"busstations": 4}], [12942761.034853589, 4841882.1373, 500, {"busstations": 1}], [12943627.060257375, 4842382.1373, 500, {"busstations": 1}], [12944493.085661158, 4841882.1373, 500, {"busstations": 14}], [12945359.11106494, 4842382.1373, 500, {"busstations": 37}], [12946225.136468727, 4841882.1373, 500, {"busstations": 13}], [12947091.16187251, 4842382.1373, 500, {"busstations": 7}], [12947957.187276296, 4841882.1373, 500, {"busstations": 23}], [12948823.212680079, 4842382.1373, 500, {"busstations": 6}], [12949689.238083865, 4841882.1373, 500, {"busstations": 2}], [12950555.263487648, 4842382.1373, 500, {"busstations": 6}], [12951421.288891435, 4841882.1373, 500, {"busstations": 31}], [12952287.314295217, 4842382.1373, 500, {"busstations": 4}], [12953153.339699004, 4841882.1373, 500, {"busstations": 6}], [12954019.365102787, 4842382.1373, 500, {"busstations": 55}], [12954885.390506573, 4841882.1373, 500, {"busstations": 31}], [12955751.415910356, 4842382.1373, 500, {"busstations": 16}], [12956617.441314138, 4841882.1373, 500, {"busstations": 16}], [12957483.466717925, 4842382.1373, 500, {"busstations": 35}], [12958349.492121708, 4841882.1373, 500, {"busstations": 2}], [12959215.517525494, 4842382.1373, 500, {"busstations": 17}], [12940162.958642237, 4841382.1373, 500, {"busstations": 2}], [12941028.98404602, 4840882.1373, 500, {"busstations": 2}], [12943627.060257375, 4841382.1373, 500, {"busstations": 2}], [12944493.085661158, 4840882.1373, 500, {"busstations": 4}], [12945359.11106494, 4841382.1373, 500, {"busstations": 15}], [12946225.136468727, 4840882.1373, 500, {"busstations": 2}], [12947091.16187251, 4841382.1373, 500, {"busstations": 7}], [12947957.187276296, 4840882.1373, 500, {"busstations": 12}], [12948823.212680079, 4841382.1373, 500, {"busstations": 9}], [12950555.263487648, 4841382.1373, 500, {"busstations": 6}], [12951421.288891435, 4840882.1373, 500, {"busstations": 34}], [12955751.415910356, 4841382.1373, 500, {"busstations": 2}], [12957483.466717925, 4841382.1373, 500, {"busstations": 2}], [12960081.542929277, 4840882.1373, 500, {"busstations": 4}]]};
		var Odata = obj;
		var data=[];
		max=0;
		for(var i=0;i<Odata.val.length;i++)
		{
			var aheat = {
                			attributes: {
                			count:Odata.val[i][3][searchtb]
                			},
                			geometry: {
                    		spatialReference: {wkid: 102100},
                    		type: "point",
                    		x: Odata.val[i][0],
                    		y: Odata.val[i][1]
                		}
            };
            data.push(aheat);
            if(Odata.val[i][3][searchtb]>max)
            	max = Odata.val[i][3][searchtb];
		}
		
    	heatLayer.setData(data);
		map.resize();
	}
	
	heatLayer = new HeatmapLayer({
                config: {
                    "useLocalMaximum": true,
                    "radius": 50,
                    "gradient": {
                        0.45: "rgb(000,000,255)",
                        0.55: "rgb(000,255,255)",
                        0.65: "rgb(000,255,000)",
                        0.85: "rgb(255,255,000)",
                        1.00: "rgb(255,000,000)"
                    }
                },
                "map": map,
    			"domNodeId": "heatLayer",
                "opacity": 0.85
            });
    /*
    for( var i=0;i<dataSize;i++)
	{
    	maplist[i].addLayer(agoLayerList[i]); 
	}
	*/
	map.addLayer(featureLayer);
	map.addLayer(heatLayer);
	
    function addmap(Inmap,geojsonp,Index) 
    {
		//console.log(geojsonp);
		//console.log(Index);
    	Inmap.graphics.clear();
        var json = dojo.fromJson(geojsonp);
        
        dojo.forEach(json.geojson, function(g) {
        	var graphic = new esri.Graphic(g);
        	Inmap.graphics.add(graphic);
        });
    }
    function parametercalculation(theMap,typeIndex)
    {
		  heatLayer.clearData();

          xmin = theMap.extent.xmin;
          xmax = theMap.extent.xmax;
          ymin = theMap.extent.ymin;
          ymax = theMap.extent.ymax;
          
          x = (xmin+xmax)/2;
          y = (ymin+ymax)/2;
          Rx = (xmax-xmin)/2;
          Ry = ymax-ymin;
		
		  //console.log(xmin);
		  //console.log(ymin);
		  //console.log(xmax);
		  //console.log(ymax);
		
          var zoomlevel = theMap.getZoom();
          //console.log(zoomlevel);
          var box_rad;
          switch(zoomlevel)
          {
            case 0:box_rad = 8000;break;
            case 1:box_rad = 4000;break;
            case 2:box_rad = 2000;break;
            case 3:box_rad = 1000;break;
            case 4:box_rad = 500;break;
            case 5:box_rad = 250;break;
          }
          //console.log(box_rad);
          
      var incoord = 102100;
      var inSR = new esri.SpatialReference({wkid: incoord });
      var inputpoint = new esri.geometry.Point(x, y, inSR);
          var PrjParams = new esri.tasks.ProjectParameters();
          PrjParams.geometries = [inputpoint];
          PrjParams.transformation = {wkid: parseInt(4326)};
          
         outpoint = esri.geometry.webMercatorToGeographic(inputpoint);
         //console.log(outpoint.x);
         //console.log(outpoint.y);
         var boxtype = 1;
         var params = {
					lon: outpoint.x,
					lat: outpoint.y,
					rad: Rx,
					box_rad: box_rad,
					box_typ: boxtype
				};
        var ConditionNumbers = [[2, 99, 0,120],[88, 176, 0,120],[150, 209, 0,120],[255, 213, 0,120],[255, 38, 0,120]];
		switch (typeIndex) {
					case 0:
						params.db_name = 'transportation';
						params.tab = 'busstations';
						ConditionNumbers = coloful[1];
						break;
					case 1:
						params.db_name = 'medical';
						params.tab = 'hostpital';
						ConditionNumbers = coloful[4];
						break;
					case 2:
						params.db_name = 'education';
						params.tab = 'college';
						ConditionNumbers = coloful[2];
						break;
					case 3:
						params.db_name = 'realestate';
						params.tab = 'soufun_newhouse';
						ConditionNumbers = coloful[0];
						break;
					default:
						params.db_name = 'transportation';
						params.tab = 'busstations';
						ConditionNumbers = coloful[0];
						break;
		}
		script.get("http://beta.arcgisonline.cn:8888/query", {
			jsonp: "callback",
			query: params
		}).then(function(data) {
			console.log("ok");
			obj = dojo.fromJson(data);
			console.log("Heating");
			console.log(box_rad);
			var newheatlayerwidth = (box_rad/(xmax-xmin))*document.getElementById("heatmapArea").clientWidth;
			console.log(newheatlayerwidth);
			heatLayer.config.radius = newheatlayerwidth;
			getHeatData(obj,params.tab);
		}, function(err) {
			console.warn("error");
		});		
	}

    array.forEach(maplist, function(map, index) {
		on(map, "load", function() {
			parametercalculation(map, index);
		});
		on(map,"zoom-start",function(){
			heatLayer.clearData();
		});
		on(map, "zoom-end", function() {
			//map.graphics.clear();
			parametercalculation(map, index);
		});
		on(map, "pan-end", function() {
			parametercalculation(map, index);
		});
	});
    	
});
</script>
 
</head>
 
<body class="claro"> 
  <div id="heatmapArea" data-dojo-type="dijit/layout/BorderContainer" 
         data-dojo-props="design:'headline', gutters:false" 
         style="width:100%;height:100%;margin:0;">
      <div id="heatLayer"></div>
      <div id="map" 
           data-dojo-type="dijit/layout/ContentPane" 
           data-dojo-props="region:'center'" 
           style="padding:0;">
           
      </div>
    </div>
</body> 
 
</html>
